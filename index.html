<html>
    <head>
        <title>Placar Sinuca</title>
        <meta charset="UTF-8"/>
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet"/>

        <style>

            body {
                margin: 2%;                
                font-family: 'Varela Round'
            }

            .container {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .header{
                display: flex;
                font-size: 5em;
                background-color: grey;
                justify-content: space-between;
            }

            .toolbar{
                display: flex;
                background-color: grey ;
            }

            .toolbar-button {
                width: 90px;
                height: 90px;
                border-radius: 50%;
                margin: 10px;
                display: flex;
                align-items: center;
                justify-items: center;
                justify-content: center;
                cursor: pointer;
                -webkit-box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                -moz-box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                background-color: #192e8f;
                fill: aliceblue;
                font-size: small;
            }

            .toolbar-button svg {
                vertical-align: middle;
            }

            .scoreBoard {
                display: flex;
                flex: 2;
                background-color: grey;
                align-items: center;
                justify-content: space-between;
            }

            .scoreBoard .text {
                display: flex;
                flex-direction: column;
                font-size: 6em;
                flex-wrap: nowrap;
            }

            .playerName {
                border-radius: 5px;
                border-width:1px;
                border-style: solid;
                background-color: rgba(120, 144, 156);
                border-color: rgba(100, 124, 136);
                font-size: x-large;
            }

            .scoreBoard .score-diff {
                display: flex;
                font-size: 10em;
                margin: 1%;
            }

            .potList {
                display: flex;
                flex: 1;
                background-color: lightslategray;
                font-size: 3em;
            }

            .potList.active{
                background-color:rgb(139, 146, 163);
                box-shadow: 0px -15px 36px -3px rgba(0, 0, 0, 0.5);
                /*border: black dashed 2px;*/
            }

            .balls {
                display: flex;
                flex: .6;
                flex-wrap: wrap;
                justify-content: space-evenly;
                align-items: center;
                background-color: lightgray;
            }

            .ball {
                height: 110px;
                width: 110px;
                border-radius: 50%;
                margin-right: 5px;
                margin-top: 5px;
                box-shadow: 0px 3px 26px -3px rgba(0, 0, 0, 0.41);
            }
            
            .b1 {background-color: rgb(244, 67, 54)}
            .b2 {background-color: rgb(255, 241, 118)}
            .b3 {background-color: rgb(124, 179, 66)}
            .b4 {background-color: rgb(121, 85, 72)}
            .b5 {background-color: rgb(2, 119, 189)}
            .b6 {background-color: rgb(240, 98, 146)}
            .b7 {background-color: rgba(0, 0, 0)}
            .b-7 {background-color: rgb(102, 102, 102)}

            .winning {
                color: darkgreen
            }
            
            .loosing {
                color: darkred
            }

            .correction {
                background-color: rosybrown;
            }

            .correcting {
                background-color: greenyellow;
            }

            .reset {
                background-color: brown;
            }

            .potHistory {
                display: flex;
                min-height: 70px;
                padding: 25px;
            }

            .potHistory ul, ol{
                display: flex;
                flex-flow: wrap;
                list-style: none;
            }

            .potHistory li {
                border-radius: 50%;
                margin: 2px;
                width: 65px;
                height: 65px;
            }
        </style>
    </head>
    <body>
        <script src="https://unpkg.com/react@16/umd/react.development.js" ></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
    
        <script type="text/babel">
            const sum = (a, b) => Math.abs(parseInt(a)) + Math.abs(parseInt(b));

            class Ball extends React.Component{
                constructor(props) {
                    super(props);
                }

                render(){
                    return <div className={`ball b${this.props.number}`} onClick={ (e) => this.props.handler(this.props.number)}></div>
                }
            }

            class PotHistory extends React.Component{
                constructor(props){
                    super(props)
                }


                render(){
                    return (
                        <div className={'potHistory'}>
                            <ul>
                            {
                                this.props.h.map((e, i) => {
                                    return <li key={i} className={`b${e}`} onClick={ (e) =>  this.props.deletePot(i)}></li>
                                })
                            }
                            </ul>
                        </div>
                    )
                }
            }

            class ScoreBoard extends React.Component{
                constructor(props){
                    super(props);

                    let lastState = this.restoreState()
                    let initialState = this.initialScoreState()

                    this.state = Object.assign(initialState, {p1Name: "Jogador A", p2Name: "Jogador B"}, lastState)

                    this.addPot = this.addPot.bind(this)
                    this.updatePlayerName = this.updatePlayerName.bind(this)
                    this.toggleCorrecting = this.toggleCorrecting.bind(this)
                    this.resetScores = this.resetScores.bind(this)
                    this.switchPlayer = this.switchPlayer.bind(this)
                    this.deletePot = this.deletePot.bind(this)
                }

                setState(s){
                    let newState = {}
                    newState = Object.assign(newState, this.state, s)

                    super.setState(s)
                    
                    document.cookie = "scoreboard_state=" + JSON.stringify(newState)
                }

                restoreState(){
                    let cookie = document.cookie.replace(/.*scoreboard_state=({.*?}).*/, "$1")

                    return cookie ? JSON.parse(cookie) : cookie
                }

                handlePlayerSwitch(p){
                    if( !this.state.correcting ){
                        this.switchPlayer(p)
                    }
                }

                switchPlayer(p){
                    if(p){
                        if(p === 1){
                            this.setState({p1Playing: true})
                        }else{
                            this.setState({p1Playing: false})
                        }
                    }else{
                        let currentlyPlaying = this.state.p1Playing;
                        currentlyPlaying = !currentlyPlaying
    
                        this.setState({p1Playing: currentlyPlaying})
                    }
                }

                initialScoreState(){
                    return {
                        s1: [],
                        s2: [],
                        p1Score: 0,
                        p2Score: 0,
                        p1Playing: true,
                        correcting: false
                    }
                }

                resetScores(){
                    if( confirm("Quer resetar as pontuações?") ){
                        this.setState(this.initialScoreState())
                    }
                }

                addPot(n){
                    let newState = {}

                    if(n === "-7"){
                        if(this.state.p1Playing){
                            newState.s1 = this.state.s1 
                            newState.s2 = this.state.s2.concat(n)
                        } else{
                            newState.s1 = this.state.s1.concat(n) 
                            newState.s2 = this.state.s2
                        }
                    } else {
                        if(this.state.p1Playing){
                            newState.s1 = this.state.s1.concat(n)
                            newState.s2 = this.state.s2
                        }else{
                            newState.s2 = this.state.s2.concat(n)
                            newState.s1 = this.state.s1
                        }
                    }
                    
                    newState = Object.assign(this.updateScores(newState), newState)

                    this.setState(newState)
                }

                deletePot(i){
                    if( this.state.correcting ){
                        let potHistory = this.state.p1Playing ? this.state.s1 : this.state.s2
                        
                        potHistory.splice(i, 1)
                        
                        this.toggleCorrecting()
                        let state = {[this.state.p1Playing ? 's1' : 's2']: potHistory}
                        state = Object.assign(this.updateScores(state), state)
                        this.setState(state)
                    }
                }

                updateScores(state){
                    let result = {}

                    if(state.s1) result.p1Score = state.s1.reduce(sum, 0)
                    if(state.s2) result.p2Score = state.s2.reduce(sum, 0)

                    return result
                }

                updatePlayerName(e){
                    let name = prompt("Nome do jogador", e.target.textContent)
                    if( name != null && name !=="" ){
                        this.setState({[this.state.p1Playing ? 'p1Name' : 'p2Name']: name })
                    }
                }

                toggleCorrecting(){
                    this.setState({correcting: !this.state.correcting})
                }

                render(){
                    let scoreDiff = this.state.p1Score - this.state.p2Score
                    let diffClassName = ''
                    if(scoreDiff > 0 ){
                        if(this.state.p1Playing){
                            diffClassName = 'winning'
                        }else{
                            diffClassName = 'loosing'
                        }
                    }else if(scoreDiff < 0){
                        if(this.state.p1Playing){
                            diffClassName = 'loosing'
                        }else{
                            diffClassName = 'winning'
                        }
                    }

                    return <div className={'container'}>
                        <div className={'header'}>Placar Sinuca
                            <div className={'toolbar'}>
                                <div className={`toolbar-button ${this.state.correcting ? 'correcting' : 'correction'}`} onClick={this.toggleCorrecting} >
                                    <svg width="62" height="62" xmlns="http://www.w3.org/2000/svg">
                                        /* Created with Method Draw - http://github.com/duopixel/Method-Draw/ */
                                        <g class="layer">
                                            <path d="m8.56408,20.78942c0.00134,-0.53203 0.45608,-3.79405 1.0109,-7.24896c1.73002,-10.77305 1.75548,-10.82059 3.95201,-7.38698l1.29956,2.03147l3.80056,-2.00923c5.02695,-2.65756 11.02526,-3.64069 16.53911,-2.71073c2.34057,0.39478 4.82408,1.03642 5.51893,1.42587c1.37953,0.77319 1.2911,1.43719 -0.90762,6.81512c-1.20507,2.94754 -1.32074,3.03155 -3.40237,2.47115c-3.543,-0.95378 -9.31202,-0.65335 -12.09733,0.62997l-2.6115,1.20328l1.83308,2.00378c1.00819,1.10211 1.57933,2.16805 1.26919,2.36878c-0.31014,0.20074 -4.08353,0.59197 -8.38528,0.86938c-6.45409,0.41625 -7.82101,0.33535 -7.81925,-0.46289l0,0l0,-0.00002l0.00001,0.00001zm33.23349,29.70351l-2.79586,-3.87814l2.54564,-2.57799c2.62005,-2.6533 4.50967,-6.37851 5.34215,-10.53163l0.47507,-2.37002l-2.74006,0.45884c-1.50704,0.2524 -2.74935,0.2196 -2.76067,-0.07284c-0.05292,-1.36538 7.11226,-14.82492 7.80873,-14.66845c1.09508,0.24601 12.20537,10.32375 12.20537,11.071c0,0.33351 -1.16765,0.80195 -2.59476,1.04093l-2.59476,0.43452l-0.25609,4.63395c-0.32846,5.94322 -3.31882,12.80252 -7.48223,17.16277c-1.66753,1.74639 -3.32996,3.17524 -3.69427,3.17524c-0.36433,0 -1.92053,-1.74519 -3.45825,-3.87818l0,0l-0.00001,0zm-25.23823,10.87013c0,-0.42881 0.43924,-1.6692 0.9761,-2.75645c0.97402,-1.9726 0.96838,-1.98217 -2.66284,-4.50717c-5.68131,-3.95052 -9.90423,-10.96245 -11.23253,-18.65104l-0.43547,-2.52065l3.10491,-0.44568c6.40042,-0.91876 6.45887,-0.89098 7.74071,3.67754c0.86499,3.08284 1.92884,4.93032 4.22214,7.33203c1.68617,1.76591 3.30137,3.05822 3.58932,2.87185c0.28795,-0.18637 0.70473,-1.28763 0.92618,-2.44724c0.22146,-1.15961 0.68323,-2.1084 1.02618,-2.1084c0.78735,0 8.20179,12.24335 8.3195,13.73784c0.07861,0.99816 -3.92944,2.7264 -14.37503,6.19844c-0.66606,0.22138 -1.19918,0.05201 -1.19918,-0.38106l0,0l0.00001,0l0,-0.00001z" fill="#0005" id="svg_3" stroke="#000" stroke-dasharray="null" stroke-linecap="null" stroke-linejoin="null" stroke-width="null"/>
                                        </g>
                                    </svg>
                                </div>
                                <div className={`toolbar-button reset`} onClick={this.resetScores} >Reset</div>
                            </div>
                        </div>
                        <div className={'scoreBoard'}>
                            <div className={'text'}>
                                <div onClick={this.updatePlayerName}>{this.state.p1Playing ? this.state.p1Name: this.state.p2Name}</div><br/>
                                <div>{this.state.p1Playing ? this.state.p1Score: this.state.p2Score} pontos</div>
                            </div>
                            <div className={`score-diff ${diffClassName}`}>{Math.abs(scoreDiff)}</div>
                        </div>
                        <div className={`potList ${this.state.p1Playing ? 'active': ''}`} onClick={this.handlePlayerSwitch.bind(this, 1)}>
                            {this.state.p1Name}
                            <PotHistory h={this.state.s1} deletePot={this.deletePot}/>
                        </div>
                        <div className={`potList ${this.state.p1Playing ? '': 'active'}`} onClick={this.handlePlayerSwitch.bind(this, 2)}>
                            {this.state.p2Name}
                            <PotHistory h={this.state.s2} deletePot={this.deletePot}/>
                        </div>
                        <div className={'balls'}>
                            <Ball number="1" handler={this.addPot}/>
                            <Ball number="2" handler={this.addPot}/>
                            <Ball number="3" handler={this.addPot}/>
                            <Ball number="4" handler={this.addPot}/>
                            <Ball number="5" handler={this.addPot}/>
                            <Ball number="6" handler={this.addPot}/>
                            <Ball number="7" handler={this.addPot}/>
                            <Ball number="-7" handler={this.addPot}/>
                        </div>
                    </div>
                }
            }

            ReactDOM.render(<ScoreBoard/>, document.getElementById('scoreboard'));
        </script>
        <div id="scoreboard"></div>
    </body>
</html>