<html>
    <head>
        <title>Placar Sinuca</title>
        <meta charset="UTF-8"/>
        <style>
            html, body {
                margin: 0;
                max-width: 100%;
                max-height: 100%;
            }

            body {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #eceff4
            }

            .scoreBoard {
                position: relative;
                display: flex;
                width: 900px;
                min-width: 750px;
                height: 500px;
            }

            .currentPlayer {
                top: 0;
                width: 450px;
                min-width: 150px;
                height: 100%;
                background-color: rgb(120, 144, 156);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                flex: initial;
            }

            .currentPlayer *{
                display: flex;
                margin-bottom: auto;
            }

            .currentPlayer .playerName {
                border-radius: 5px;
                border-width:1px;
                border-style: solid;
                border-color: rgba(100, 124, 136);
                background-color: rgba(120, 144, 156)
            }

            .currentPlayer .playerName:focus{
                background-color: rgba(140, 164, 176)
            }

            .currentPlayer .diff {
                font-size: 28px;
            }

            .currentPlayer .winning {
                color: darkgreen
            }
            
            .currentPlayer .loosing {
                color: darkred
            }

            .scores{
                width: calc(100% - 40px);
                height: calc(100% - 40px);
                margin: 20px;
                margin-left: 0;
                border-radius: 8px;
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
                display: flex;
                justify-content: flex-end;
                flex-flow: wrap;
                flex: auto;
                background-color: white;
            }

            .scores .content{
                display: flex;
                flex-flow: column;
                width: calc(100% - 10px)
            }

            .scores .playerScore {
                position: relative;
                display: flex;
                flex-direction: row;
                align-items: center;
                margin: 5px;
                border-bottom: 1px solid #e6e6e6;
            }

            .scores .playerScore.active{
                background-color: #f4f4f4;
                box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
            }
            
            .scores .content .playerScore .text {
                display: flex;
                position: absolute;
                top: 5px;
            }

            .ballList {
                display: flex;
                flex-flow: wrap;
                justify-content: space-evenly; 
                margin-top: auto;
                margin-bottom: 15px
            }

            .ballList .ball {
                height: 90px;
                width: 90px;
                border-radius: 50%;
                margin-right: 10px;
                margin-top: 10px;
                position: relative;
            }

            .b1 {background-color: red;}
            .b2 {background-color: yellow;}
            .b3 {background-color: green;}
            .b4 {background-color: brown;}
            .b5 {background-color: blue;}
            .b6 {background-color: hotpink;}
            .b7 {background-color: black;}
            .b-7 {background-color: grey;}

            .potHistory {
                display: flex;
                min-height: 70px;
                padding: 25px;
            }

            .potHistory ul, ol{
                display: flex;
                flex-flow: wrap;
                list-style: none;
            }

            .potHistory li {
                border-radius: 50%;
                margin: 2px;
                width: 45px;
                height: 45px;
            }

            .currentPlayer .buttons{
                display: flex;
                flex-flow: row;
                justify-content: space-evenly;
                width: 100%;
            }

            .playerSwitcher {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-items: center;
                justify-content: center;
                cursor: pointer;
                -webkit-box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                -moz-box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                box-shadow: 0px 2px 36px -3px rgba(0, 0, 0, 0.5);
                background-color: #192e8f;
                fill: aliceblue
            }

            .playerSwitcher svg {
                margin: 25px 0px 25px 0px;
                width: 30px;
                height: 30px;
                opacity: 0.3;
            }

            .correction {
                background-color: rosybrown;
            }

            .correcting {
                background-color: greenyellow;
            }

            .reset {
                background-color: brown;
            }

        </style>
    </head>
    <body>
        <script src="https://unpkg.com/react@16/umd/react.development.js" ></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
    
        <script type="text/babel">
            const sum = (a, b) => parseInt(a) + parseInt(b);

            class Ball extends React.Component{
                constructor(props) {
                    super(props);
                }

                render(){
                    return <span className={`ball b${this.props.number}`} onClick={ (e) => this.props.handler(this.props.number)}></span>
                }
            }

            class PotHistory extends React.Component{
                constructor(props){
                    super(props)
                }

                render(){
                    return (
                        <div className={'potHistory'}>
                            <ul>
                            {
                                this.props.h.map((e, i) => {
                                    return <li key={i} className={`b${e}`} onClick={ (e) =>  this.props.deletePot(i)}></li>
                                })
                            }
                            </ul>
                        </div>
                    )
                }
            }

            class ScoreBoard extends React.Component{
                constructor(props) {
                    super(props);

                    let lastState = this.restoreState()
                    let initialState = this.initialScoreState()

                    this.state = Object.assign(initialState, {p1Name: "Jogador A", p2Name: "Jogador B"}, lastState)

                    this.addPot = this.addPot.bind(this)
                    this.switchPlayer = this.switchPlayer.bind(this)
                    this.toggleCorrecting = this.toggleCorrecting.bind(this)
                    this.deletePot = this.deletePot.bind(this)
                    this.updateScores = this.updateScores.bind(this)
                    this.updatePlayerName = this.updatePlayerName.bind(this)
                    this.resetScores = this.resetScores.bind(this)
                }

                restoreState(){
                    let cookie = document.cookie.replace(/.*scoreboard_state=({.*?}).*/, "$1")

                    return cookie ? JSON.parse(cookie) : cookie
                }

                setState(s){
                    let newState = {}
                    newState = Object.assign(newState, this.state, s)

                    super.setState(s)
                    
                    document.cookie = "scoreboard_state=" + JSON.stringify(newState)
                }

                initialScoreState(){
                    return {
                        s1: [],
                        s2: [],
                        p1Score: 0,
                        p2Score: 0,
                        p1Playing: true,
                        correcting: false
                    }
                }

                resetScores(){
                    if( confirm("Quer resetar as pontuações?") ){
                        this.setState(this.initialScoreState())
                    }
                }

                addPot(n){
                    let newState = {}

                    if(n === "-7"){
                        if(this.state.p1Playing){
                            newState.s2 = this.state.s2.concat(n * -1)
                            newState.s1 = this.state.s1 
                        } else{
                            newState.s1 = this.state.s1.concat(n * -1) 
                            newState.s2 = this.state.s2
                        }
                    } else {
                        if(this.state.p1Playing){
                            newState.s1 = this.state.s1.concat(n)
                            newState.s2 = this.state.s2
                        }else{
                            newState.s2 = this.state.s2.concat(n)
                            newState.s1 = this.state.s1
                        }
                    }
                    
                    newState = Object.assign(this.updateScores(newState), newState)

                    this.setState(newState)
                }

                updateScores(state){
                    let result = {}

                    if(state.s1) result.p1Score = state.s1.reduce(sum, 0)
                    if(state.s2) result.p2Score = state.s2.reduce(sum, 0)

                    return result
                }

                deletePot(i){
                    if( this.state.correcting ){
                        let potHistory = this.state.p1Playing ? this.state.s1 : this.state.s2
                        
                        potHistory.splice(i, 1)
                        
                        this.toggleCorrecting()
                        let state = {[this.state.p1Playing ? 's1' : 's2']: potHistory}
                        state = Object.assign(this.updateScores(state), state)
                        this.setState(state)
                    }
                }

                switchPlayer(){
                    let currentlyPlaying = this.state.p1Playing;
                    currentlyPlaying = !currentlyPlaying

                    this.setState({p1Playing: currentlyPlaying})
                }

                toggleCorrecting(){
                    this.setState({correcting: !this.state.correcting})
                }

                updatePlayerName(e){
                    let name = e.target.value;
                    this.setState({[this.state.p1Playing ? 'p1Name' : 'p2Name']: name })
                }

                render(){
                    let scoreDiff = this.state.p1Score - this.state.p2Score
                    let diffClassName = ''
                    if(scoreDiff > 0 ){
                        if(this.state.p1Playing){
                            diffClassName = 'winning'
                        }else{
                            diffClassName = 'loosing'
                        }
                    }else if(scoreDiff < 0){
                        if(this.state.p1Playing){
                            diffClassName = 'loosing'
                        }else{
                            diffClassName = 'winning'
                        }
                    }

                    return <div className={'scoreBoard'}>
                            <div className={'currentPlayer'}>
                                <h1>Placar Sinuca</h1>
                                <input type="text" className={'playerName'} value={`${this.state.p1Playing ? this.state.p1Name: this.state.p2Name}`} onChange={this.updatePlayerName}/>
                                <h2>{this.state.p1Playing ? this.state.p1Score: this.state.p2Score} pontos</h2>
                                
                                <div className={`diff ${diffClassName}`}>
                                    Diferença: {Math.abs(scoreDiff)}
                                </div>
                                <div className={'buttons'}>
                                    <div className='playerSwitcher' onClick={this.switchPlayer}>
                                            <svg
                                                height="403pt"
                                                viewBox="0 -26 403.24 403"
                                                width="403pt"
                                                xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M327.785 134.543c3.922 3.89 10.254 3.863 14.145-.059l58.41-58.91c3.879-3.91 3.867-10.219-.028-14.11L341.898 3.052c-3.906-3.906-10.238-3.906-14.14 0-3.906 3.902-3.906 10.234 0 14.14l41.34 41.344H309.03a90.46 90.46 0 0 0-71.824 35.77l-48.488 64.222-48.489-64.222a90.467 90.467 0 0 0-71.824-35.77H10c-5.523 0-10 4.477-10 10 0 5.524 4.477 10 10 10h58.398a70.36 70.36 0 0 1 55.868 27.82l51.921 68.766-51.917 68.766a70.36 70.36 0 0 1-55.868 27.82H10c-5.523 0-10 4.477-10 10s4.477 10 10 10h58.398a90.474 90.474 0 0 0 71.829-35.77l48.492-64.218 48.488 64.222a90.463 90.463 0 0 0 71.828 35.77h60.067l-41.344 41.344c-3.906 3.906-3.906 10.238 0 14.14 3.902 3.907 10.234 3.907 14.14.004l58.414-58.414c3.895-3.894 3.907-10.203.028-14.113l-58.41-58.91a10.002 10.002 0 1 0-14.203 14.082l41.515 41.867h-60.215a70.359 70.359 0 0 1-55.863-27.82l-51.918-68.77 51.918-68.766a70.36 70.36 0 0 1 55.867-27.82h60.207l-41.511 41.867c-3.891 3.922-3.864 10.254.058 14.141zm0 0" />
                                            </svg>
                                    </div>
                                    <div className={`playerSwitcher ${this.state.correcting ? 'correcting' : 'correction'}`} onClick={this.toggleCorrecting} >↺</div>
                                    <div className={`playerSwitcher reset`} onClick={this.resetScores} >Reset</div>
                                </div>
                            </div>
                            <div className={'scores'}>
                                <div className={'content'}>
                                    <div className={`playerScore ${this.state.p1Playing ? 'active': ''}`}>
                                        <div className={'text'}>
                                                {this.state.p1Name}: {this.state.p1Score}
                                        </div>
                                        <PotHistory h={this.state.s1} deletePot={this.deletePot}/>
                                    </div>
                                    <div className={`playerScore ${this.state.p1Playing ? '': 'active'}`}>
                                        <div className={'text'}>
                                            {this.state.p2Name}: {this.state.p2Score}
                                        </div>
                                        <PotHistory h={this.state.s2} deletePot={this.deletePot}/>
                                    </div>
                                    <div className={'ballList'}>
                                        <Ball number="1" handler={this.addPot}/>
                                        <Ball number="2" handler={this.addPot}/>
                                        <Ball number="3" handler={this.addPot}/>
                                        <Ball number="4" handler={this.addPot}/>
                                    </div>
                                    <div className={'ballList'}>
                                        <Ball number="5" handler={this.addPot}/>
                                        <Ball number="6" handler={this.addPot}/>
                                        <Ball number="7" handler={this.addPot}/>
                                        <Ball number="-7" handler={this.addPot}/>
                                    </div>
                                </div>
                            </div>
                           </div>
                }
            }

            ReactDOM.render(
                <ScoreBoard/>,
                document.getElementById('scoreboard')
            );
        </script>
        <div id="scoreboard"></div>
    </body>
</html>